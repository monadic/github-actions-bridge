version: '3.8'

services:
  actions-bridge:
    build:
      context: .
      dockerfile: Dockerfile
    image: confighub/actions-bridge:latest
    container_name: actions-bridge
    environment:
      - CONFIGHUB_WORKER_ID=${CONFIGHUB_WORKER_ID}
      - CONFIGHUB_WORKER_SECRET=${CONFIGHUB_WORKER_SECRET}
      - CONFIGHUB_URL=${CONFIGHUB_URL:-https://api.confighub.com}
      - ACTIONS_BRIDGE_BASE_DIR=/var/lib/actions-bridge
      - ACT_DEFAULT_IMAGE=catthehacker/ubuntu:act-latest
      - MAX_CONCURRENT_WORKFLOWS=5
      - DEBUG=${DEBUG:-false}
    volumes:
      # Docker socket for act
      - /var/run/docker.sock:/var/run/docker.sock
      # Persistent workspace
      - ./workspace:/var/lib/actions-bridge
      # Configuration
      - ./config:/etc/actions-bridge:ro
      # Cache for act
      - act-cache:/tmp/act-cache
    ports:
      - "8080:8080"  # Health check and metrics
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - actions-network

  # Optional: Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: actions-prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    networks:
      - actions-network
    depends_on:
      - actions-bridge

  # Optional: Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: actions-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      - actions-network
    depends_on:
      - prometheus

volumes:
  act-cache:
    name: actions-bridge-act-cache
  prometheus-data:
    name: actions-bridge-prometheus-data
  grafana-data:
    name: actions-bridge-grafana-data

networks:
  actions-network:
    name: actions-bridge-network
    driver: bridge
