name: Workflow with Secrets
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup deployment
        run: |
          echo "Preparing deployment to ${{ github.event.inputs.environment }}"
          echo "Space: ${{ env.CONFIGHUB_SPACE }}"
          echo "Unit: ${{ env.CONFIGHUB_UNIT }}"
      
      - name: Use database credentials
        env:
          DB_HOST: ${{ env.CONFIG_DATABASE_HOST }}
          DB_PORT: ${{ env.CONFIG_DATABASE_PORT }}
          DB_NAME: ${{ env.CONFIG_DATABASE_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "Connecting to database at $DB_HOST:$DB_PORT/$DB_NAME"
          # Simulate database connection test
          if [ -n "$DB_PASSWORD" ]; then
            echo "✓ Database credentials are set"
          else
            echo "✗ Database credentials missing"
            exit 1
          fi
      
      - name: Use API credentials
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_SECRET: ${{ secrets.API_SECRET }}
        run: |
          # Test API connectivity
          if [ -n "$API_KEY" ] && [ -n "$API_SECRET" ]; then
            echo "✓ API credentials configured"
            # Simulate API call
            echo "Making API request..."
            echo "Response: 200 OK"
          else
            echo "✗ API credentials missing"
            exit 1
          fi
      
      - name: Deploy application
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          echo "Starting deployment..."
          # Simulate deployment steps
          echo "- Building application"
          echo "- Pushing to registry"
          echo "- Updating deployment"
          echo "✓ Deployment complete"
      
      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          echo "- Health check: OK"
          echo "- Service status: Running"
          echo "✓ Verification complete"
